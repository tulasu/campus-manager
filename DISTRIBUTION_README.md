# Система распределения студентов по общежитиям

## Обзор

Система автоматически распределяет студентов по общежитиям на основе следующих критериев:
- Институт
- СВО, ЧАЭС, Инвалидность (приоритетные категории)
- Расстояние до вуза
- Многодетная семья
- Курение

## Архитектура

**Новые модели в `domain/distribution.py`:**
- `StudentDistribution` - исходные данные студентов
- `InstituteWeights` - веса критериев по институтам
- `NormalizedStudent` - нормализованные данные
- `ScoredStudent` - финальные баллы и рейтинг

**Слой данных:**
- `DistributionRepository` - работа с 3 листами Google Sheets
- `IDistributionRepository` - интерфейс репозитория

**Бизнес-логика:**
- `CalculationService` - основной алгоритм распределения

## Алгоритм работы

1. **Сбор данных**: Чтение студентов с листа `students_distribution`
2. **Получение весов**: Чтение весов с листа `weights`
3. **Нормализация**: Расстояние делится на 500
4. **Расчет баллов**: Умножение критериев на веса института
5. **Сортировка**:
   - Сначала приоритетные (СВО/ЧАЭС/Инвалидность)
   - Потом остальные
   - Внутри групп по убыванию общего балла
6. **Сохранение**: Запись рейтинга на лист `ranking`

## Настройка Google Sheets

### Лист 1: `students_distribution`
Столбцы:
```
ФИО | Пол | Институт | СВО | ЧАЭС | Инвалидность | Курение | Расстояние | Многодетная семья
```

### Лист 2: `weights`
Столбцы:
```
Институт | Баллы за институт | СВО | ЧАЭС | Инвалидность | Расстояние | Многодетная семья
```

Пример:
```
ИПМКН | 1 | 1 | 1 | 1 | 1 | 1
Горный | 1 | 1 | 1 | 1 | 1 | 1
Другой | 1 | 1 | 1 | 1 | 1 | 1
```

### Лист 3: `ranking`
Создается автоматически с результатами

## API эндпоинты

### POST /calculate
Запускает расчет распределения

**Response:**
```json
{
  "success": true,
  "message": "Распределение успешно рассчитано для 15 студентов",
  "students_count": 15
}
```

### GET /students
Возвращает список студентов (старый функционал)

## Запуск приложения

1. **Настройка .env:**
```bash
cp .env.example .env
# Заполните GOOGLE_SERVICE_ACCOUNT и GOOGLE_SHEET_ID
```

2. **Запуск:**
```bash
python main.py
```

3. **Доступ:**
- Фронтенд: http://localhost:8000
- API документация: http://localhost:8000/docs

## Использование

1. Откройте http://localhost:8000
2. Нажмите кнопку "Распределить"
3. Дождитесь завершения расчета
4. Результаты появятся на листе `ranking` в Google Sheets

## Особенности алгоритма

### Нормализация
- Расстояние: `distance / 500`
- Булевы поля: 0 или 1
- Приоритетные категории отмечаются отдельно

### Расчет баллов
```
total_score = institute_score +
              svo * svo_weight +
              chaes * chaes_weight +
              disability * disability_weight +
              smoking * 1 +
              (distance/500) * distance_weight +
              large_family * large_family_weight
```

### Сортировка
1. **Приоритетные студенты** (СВО/ЧАЭС/Инвалидность != 0)
2. **Обычные студенты**
3. Внутри каждой группы сортировка по `total_score` по убыванию

## Архитектурные преимущества

- **Чистое разделение ответственности** - слои не зависят друг от друга
- **Dependency Injection** - легкая замена компонентов
- **Асинхронность** - эффективная работа с Google Sheets API
- **Валидация данных** - Pydantic модели обеспечивают безопасность
- **Расширяемость** - легко добавлять новые критерии